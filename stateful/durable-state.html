<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="description" content="spekka-docs">
<meta name="generator" content="Paradox, paradox-material-theme=0.6.0, mkdocs-material=3.0.3">

<meta name="lang:clipboard.copy" content="Copy to clipboard">
<meta name="lang:clipboard.copied" content="Copied to clipboard">
<meta name="lang:search.language" content="">
<meta name="lang:search.pipeline.stopwords" content="true">
<meta name="lang:search.pipeline.trimmer" content="true">
<meta name="lang:search.result.none" content="No matching documents">
<meta name="lang:search.result.one" content="1 matching document">
<meta name="lang:search.result.other" content="# matching documents">
<meta name="lang:search.tokenizer" content="">


<meta name="description" content="spekka-docs">
<link rel="shortcut icon" href="../assets/images/favicon.png">
<title>Durable State Stateful Flow · Spekka</title>
<link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
<link rel="stylesheet" href="../lib/material__tabs/dist/mdc.tabs.min.css">
<link rel="stylesheet" href="../lib/prettify/prettify.css">
<script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
<style>
body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}
code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}
</style>
<link rel="stylesheet" href="../assets/fonts/font-awesome.css">
<link rel="stylesheet" href="../assets/fonts/material-icons.css">
<link rel="stylesheet" href="../assets/stylesheets/paradox-material-theme.css">
</head>
<body
>
<input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
<input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
<label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
<header class="md-header" data-md-component="header">
<nav class="md-header-nav md-grid">
<div class="md-flex">
<div class="md-flex__cell md-flex__cell--shrink">
<a href="../index.html" title="Spekka" class="md-header-nav__button md-logo">
<i class="md-icon">polymer</i>
</a>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
</div>
<div class="md-flex__cell md-flex__cell--stretch">
<div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
<span class="md-header-nav__topic">
Spekka
</span>
<span class="md-header-nav__topic">
Durable State Stateful Flow
</span>
</div>
</div>
<form name="search" style="display: none">
<input type="text" name="query">
</form>
<div class="md-flex__cell md-flex__cell--shrink">
<div class="md-header-nav__source">
<a href="https://github.com/spekka/spekka"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
spekka/spekka
</div>
</a>

</div>
</div>
</div>
</nav>
</header>

<div class="md-container">
<main class="md-main">
<div class="md-main__inner md-grid" data-md-component="container">
<div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--primary" data-md-level="0" style="visibility: hidden">
<label class="md-nav__title md-nav__title--site" for="drawer">
<a href="../index.html" title="Spekka" class="md-nav__button md-logo">
<span class="md-nav__button md-logo">
<i class="md-icon">polymer</i>
</a>
<a href="../index.html" title="Spekka">
Spekka
</a>
</label>
<div class="md-nav__source">
<a href="https://github.com/spekka/spekka"
title="Go to repository"
class="md-source"
data-md-source="github">
<div class="md-source__icon">
<i class="fa fa-github"></i>
</div>
<div class="md-source__repository">
spekka/spekka
</div>
</a>

</div>
<ul>
  <li><a href="../context/index.html" class="page">Spekka Context</a>
  <ul>
    <li><a href="../context/flow-with-extended-context.html" class="page">Flow With Extended Context</a></li>
    <li><a href="../context/partitions.html" class="page">Partitions</a></li>
  </ul></li>
  <li><a href="../stateful/index.html" class="page">Spekka Stateful</a>
  <ul>
    <li><a href="../stateful/event-based.html" class="page">Event Based Stateful Flows</a></li>
    <li><a href="../stateful/durable-state.html" class="active page">Durable State Stateful Flow</a></li>
    <li><a href="../stateful/usage.html" class="page">Stateful Flow Usage</a></li>
    <li><a href="../stateful/akkapersistence.html" class="page">Spekka Stateful Akka Persistence</a></li>
    <li><a href="../stateful/sharding.html" class="page">Spekka Stateful Sharding</a></li>
  </ul></li>
</ul>
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../stateful/durable-state.html#durable-state-stateful-flow" class="header">Durable State Stateful Flow</a>
  <ul>
    <li><a href="../stateful/durable-state.html#logic" class="header">Logic</a></li>
    <li><a href="../stateful/durable-state.html#backend" class="header">Backend</a></li>
    <li><a href="../stateful/durable-state.html#props" class="header">Props</a></li>
    <li><a href="../stateful/durable-state.html#full-example" class="header">Full example</a></li>
  </ul></li>
</ul>
</nav>

</nav>
<ul style="display: none">
<li class="md-nav__item md-version" id="project.version">
<label class="md-nav__link" for="__version">
<i class="md-icon" title="Version">label_outline</i> 0.1.1
</label>
</li>
</ul>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">Table of contents</label>
<ul>
  <li><a href="../stateful/durable-state.html#durable-state-stateful-flow" class="header">Durable State Stateful Flow</a>
  <ul>
    <li><a href="../stateful/durable-state.html#logic" class="header">Logic</a></li>
    <li><a href="../stateful/durable-state.html#backend" class="header">Backend</a></li>
    <li><a href="../stateful/durable-state.html#props" class="header">Props</a></li>
    <li><a href="../stateful/durable-state.html#full-example" class="header">Full example</a></li>
  </ul></li>
</ul>
</nav>

</div>
</div>
</div>
<div class="md-content">
<article class="md-content__inner md-typeset">
<div class="md-content__searchable">
<h1><a href="#durable-state-stateful-flow" name="durable-state-stateful-flow" class="anchor"><span class="anchor-link"></span></a>Durable State Stateful Flow</h1>
<p>Durable state stateful flow are defined directly in terms of their state type. </p>
<p>They are well suited to model <em>CRUD</em> entity where the frequency of state changes is relatively low.</p>
<h2><a href="#logic" name="logic" class="anchor"><span class="anchor-link"></span></a>Logic</h2>
<p>A <code>StatefulFlowLogic.DurableState[State, In, Out, Command]</code> is a kind of logic where inputs/commands acts directly upon the state generating an updated version of the state object.</p>
<p>The output type of the flow is not fixed, this means that a flow using a durable state logic can freely decide what to produce as output depending on the current state and input.</p>
<p>In order to adapt the counter example to use a durable state stateful flow we need to start by defining the <em>state</em> and <em>command</em> models:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/spekka/spekka/tree/v0.1.1/spekka-docs/src/main/scala/StatefulFlowDurableStateExample.scala#L44-L48" target="_blank" title="Go to snippet source">source</a><code class="language-scala">/** The state model */
case class CounterState(total: Int)

/** The command used to query the flow for its current counter value */
case class GetCounter(replyTo: ActorRef[StatusReply[Int]])</code></pre>
<p>Now that we have our models we can instantiate a logic operating on it:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/spekka/spekka/tree/v0.1.1/spekka-docs/src/main/scala/StatefulFlowDurableStateExample.scala#L52-L69" target="_blank" title="Go to snippet source">source</a><code class="language-scala">import StatefulFlowLogic._
val logic = DurableState[CounterState, CounterSample, Int, GetCounter](
  () =&gt; CounterState(0),
  (state, sample) =&gt; {
    val newCounter = state.total + sample.entrances
    println(
      s&quot;deployment:${sample.deploymentId} entrance:${sample.entranceId} - &quot; +
        s&quot;timestamp:${sample.timestamp} counter:${newCounter}&quot;
    )
    DurableState
      .ProcessingResult(CounterState(newCounter))
      .withOutput(newCounter)
  },
  (state, command) =&gt; {
    command.replyTo ! StatusReply.success(state.total)
    DurableState.ProcessingResult(state)
  }
)</code></pre>
<p>We do that by invoking <code>StatefulFlowLogic.DurableState</code> specifying the following 3 parameters:</p>
<ol>
  <li><strong>initial state:</strong> the state value to use for the first instantiation of the flow (i.e. when no state can be recovered by the backend)</li>
  <li><strong>input handler:</strong> the function used to handle stream inputs by generating the new state (possibly inspecting the current state)</li>
  <li><strong>command handler:</strong> the function used to handle commands by generating the new state (possibly inspecting the current state)</li>
</ol>
<p>The <em>input</em> handler function expects a result of type <code>StatefulFlowLogic.DurableState.ProcessingResult[State, Out]</code>. This types serves as a representation of:</p>
<ol>
  <li>The updated state generated by the input</li>
  <li>The output the flow needs to produce</li>
  <li>The side effect we want to be performed <strong>before</strong> the persisted state is updated</li>
  <li>The side effect we want to be performed <strong>after</strong> the persisted state has been successfully updated</li>
</ol>
<p>The <em>command</em> handler is similar to the <em>input</em> one apart for the fact that its result has an output type set to <code>Nothing</code>. This reflect the fact that since commands do not correspond to any particular input, in order to maintain the <em>one-to-one</em> property of Spekka flows, we cannot produce any output while handling them.</p>
<p>Thanks to the native side effect support it becomes easy to write pipelines of micro-services with <em>at-least-once</em> semantic (use Kafka as a backbone, read from <code>topicUpstream</code> and emit to <code>topicDownstream</code> inside a <strong>before</strong> side effect. If the process fails while emitting, we have a guarantee that upon restart the stream will resume processing where it left off, hence repeating the side effects.)</p>
<p>Similarly you can use <strong>after</strong> side effects to model <em>at-most-once</em> scenarios (if the system fails <strong>after</strong> the state has been modified, there is no guarantee that the logic will produce the same side effects upon restart).</p>
<p>***note Both <strong>before</strong> and <strong>after</strong> side effects are evaluated as part of the stream. This means that the flow will not produce any output until both side effects groups have been completed successfully. Similarly if any side effect fails (i.e. <code>Future.failed</code>) the stream will be failed as well. ***</p>
<h2><a href="#backend" name="backend" class="anchor"><span class="anchor-link"></span></a>Backend</h2>
<p>A <code>StatefulFlowBackend.DurableState[State, _]</code> is a kind of backend compatible with durable stated logics with the same <em>state</em> type.</p>
<p>Spekka Stateful ships with an in-memory implementation useful for testing and quick prototyping: <code>InMemoryStatefulFlowBackend.DurableState[State]</code>.</p>
<p>We can create a backend for our example with the following code:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/spekka/spekka/tree/v0.1.1/spekka-docs/src/main/scala/StatefulFlowDurableStateExample.scala#L73" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val backend = InMemoryStatefulFlowBackend.DurableState[CounterState]()</code></pre>
<h2><a href="#props" name="props" class="anchor"><span class="anchor-link"></span></a>Props</h2>
<p>Once we have define both the logic and the backend, we can obtain a <code>StatefulFlowProps</code> by invoking the <code>propsForBackend</code> method on the logic instance:</p>
<pre class="prettyprint"><button class="snippet-button copy-snippet" title="Copy snippet to clipboard">copy</button><a class="snippet-button go-to-source" href="https://github.com/spekka/spekka/tree/v0.1.1/spekka-docs/src/main/scala/StatefulFlowDurableStateExample.scala#L77" target="_blank" title="Go to snippet source">source</a><code class="language-scala">val flowProps = logic.propsForBackend(backend)</code></pre>
<h2><a href="#full-example" name="full-example" class="anchor"><span class="anchor-link"></span></a>Full example</h2>
<p>You can find the full example here: <a href="https://github.com/spekka/spekka/tree/v0.1.1/spekka-docs/src/main/scala/StatefulFlowDurableStateExample.scala">StatefulFlowDurableStateExample.scala</a>.</p>
</div>
<div>
<a href="https://github.com/spekka/spekka/tree/v0.1.1/spekka-docs/src/main/paradox/stateful/durable-state.md" title="Edit this page" class="md-source-file md-edit">
Edit this page
</a>
</div>
<div class="print-only">
<span class="md-source-file md-version">
0.1.1
</span>
</div>
</article>
</div>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-nav">
<nav class="md-footer-nav__inner md-grid">
<a href="../stateful/event-based.html" title="Event Based Stateful Flows" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
</div>
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Previous
</span>
Event Based Stateful Flows
</span>
</div>
</a>
<a href="../stateful/usage.html" title="Stateful Flow Usage" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
<div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
<span class="md-flex__ellipsis">
<span class="md-footer-nav__direction">
Next
</span>
Stateful Flow Usage
</span>
</div>
<div class="md-flex__cell md-flex__cell--shrink">
<i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
</div>
</a>
</nav>
</div>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-footer-copyright">
<div class="md-footer-copyright__highlight">
Copyright © Andrea Zito
</div>
Powered by
<a href="https://github.com/lightbend/paradox">Paradox</a>
and
<a href="https://jonas.github.io/paradox-material-theme/">Paradox Material Theme</a>

</div>
<div class="md-footer-social">
<a href="https://github.com/nivox" class="md-footer-social__link fa fa-github"></a><a href="https://twitter.com/nivox" class="md-footer-social__link fa fa-twitter"></a><a href="https://linkedin.com/in/andreazito" class="md-footer-social__link fa fa-linkedin"></a>
</div>

</div>
</div>
</footer>

</div>
<script src="../assets/javascripts/application.583bbe55.js"></script>
<script src="../assets/javascripts/paradox-material-theme.js"></script>
<script>app.initialize({version:"0.17",url:{base:"../."}})</script>
<script type="text/javascript" src="../lib/prettify/prettify.js"></script>
<script type="text/javascript" src="../lib/prettify/lang-scala.js"></script>
<script type="text/javascript">
document.addEventListener("DOMContentLoaded", function(event) {
window.prettyPrint && prettyPrint();
});
</script>
<script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","G-H13X389S63"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})});if(document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>

</body>
</html>
